pipeline {
    agent any
    environment {
        IMAGE_NAME = "flask-app"
        CONTAINER_NAME = "flask-web-server"
        NETWORK_NAME = "my-app-network"
        SSH_KEY_ID  = 'my-server-ssh-key'
        // Pass the MySQL password securely
        MYSQL_PW = credentials('mysql-root-pw')
    }

    stages {
        stage('Clean Workspace') {
            steps {
                cleanWs() // This requires the 'Workspace Cleanup' plugin
            }
        }
        stage('Setup Network') {
            steps {
                sshagent(["${SSH_KEY_ID}"]) {
                    sh "ssh -o StrictHostKeyChecking=no ${params.REMOTE_USER}@${params.REMOTE_IP} 'docker network create ${NETWORK_NAME} || true'"
                }
            }
        }

        stage('Generate Build Files') {
            steps {
                writeFile file: 'requirements.txt', text: "flask\nflask_sqlalchemy\npymysql\ncryptography\nmysql-connector-python==8.0.33"
                writeFile file: 'Dockerfile', text: """
FROM python:3.11 AS builder
WORKDIR /app
COPY requirements.txt ./
RUN apt-get update && apt-get install -y build-essential libffi-dev libssl-dev
RUN pip install --prefix=/install -r requirements.txt

FROM python:3.11-alpine
WORKDIR /app
RUN apk add --no-cache libstdc++ libpq libffi libssl3
COPY --from=builder /install /usr/local
COPY app.py ./
EXPOSE 5000
CMD [ "python", "./app.py" ]
"""
                writeFile file: 'app.py', text: """from flask import Flask, request, jsonify
import mysql.connector
import os

app = Flask(__name__)


def get_db_connection():
    return mysql.connector.connect(
        host="my-mysql-db",
        user="root",
        password=os.getenv("MYSQL_PW"),
        database="restaurant_db",
    )


@app.route("/filter/cuisine")
def filter_by_cuisine():
    cuisine = request.args.get("type")
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT * FROM restaurants WHERE cuisine_type = %s", (cuisine,))
    results = cursor.fetchall()
    conn.close()
    return jsonify(results)


@app.route("/filter/neighborhood")
def filter_by_neighborhood():
    neighborhood = request.args.get("neighborhood")
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute("SELECT * FROM restaurants WHERE neighborhood = %s", (neighborhood,))
    results = cursor.fetchall()
    conn.close()
    return jsonify(results)


@app.route("/filter/score")
def filter_by_score():
    score = request.args.get("score")
    conn = get_db_connection()
    cursor = conn.cursor(dictionary=True)
    cursor.execute(
        "SELECT * FROM restaurants WHERE ROUND(review_score, 1) >= %s", (score,)
    )
    results = cursor.fetchall()
    conn.close()
    return jsonify(results)


if __name__ == "__main__":

    app.run(host="0.0.0.0", port=5000)
"""
            }
        }

        stage('Remote Lint Check') {
            steps {
                sshagent(["${SSH_KEY_ID}"]) {
                    script {
                        sh "tar -czf project_source.tar.gz --exclude='*.tar.gz' --exclude='.git' ."
                        sh "scp -o StrictHostKeyChecking=no project_source.tar.gz ${params.REMOTE_USER}@${params.REMOTE_IP}:/tmp/"
                        sh """
                            ssh -o StrictHostKeyChecking=no ${params.REMOTE_USER}@${params.REMOTE_IP} "
                                set -e
                                mkdir -p ~/build/${IMAGE_NAME}
                                tar -xzf /tmp/project_source.tar.gz -C ~/build/${IMAGE_NAME}
                                cd ~/build/${IMAGE_NAME}
                                docker run --rm -v \\\$(pwd):/app -w /app python:3.9-slim sh -c '
                                    pip install flake8 black &&
                                    black --check --diff --quiet . &&
                                    flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
                                '
                            "
                        """
                    }
                }
            }
        }

        stage('Remote Build & Deploy') {
            steps {
                sshagent(["${SSH_KEY_ID}"]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${REMOTE_IP} "
                            set -e
                            cd ~/build/${IMAGE_NAME}
                            docker build -t ${IMAGE_NAME}:latest .
                            docker rm -f ${CONTAINER_NAME} || true
                            docker run -d --name ${CONTAINER_NAME} \
                                --network ${NETWORK_NAME} \
                                -e MYSQL_PW=${MYSQL_PW} \
                                -p 5000:5000 ${IMAGE_NAME}:latest
                        "
                    """
                }
            }
        }

        stage('Smoke Test: Neighborhood') {
            steps {
                sshagent(["${SSH_KEY_ID}"]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${params.REMOTE_USER}@${params.REMOTE_IP} "
                            for i in {1..5}; do
                                if curl -s -f 'http://localhost:5000/filter/neighborhood?neighborhood=West%20Loop' > /dev/null; then
                                    echo 'SUCCESS: Neighborhood API is UP'
                                    exit 0
                                fi
                                sleep 5
                            done
                            exit 1
                        "
                    """
                }
            }
        }
    }

    post {
        always {
            sh '''
                mkdir -p reports
                curl -s -u admin:password "$BUILD_URL/consoleText" -o reports/console.log || true
            '''
            archiveArtifacts artifacts: 'reports/console.log', fingerprint: true
        }
    }
}
